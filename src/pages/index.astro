---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';
import { NotionLoader } from '../lib/notion-loader';

// Fetch content to display
const loader = new NotionLoader(
  import.meta.env.NOTION_API_KEY,
  import.meta.env.NOTION_DATABASE_ID,
  { cacheImages: true }
);

const allContent = await loader.getAll();

// Extract unique categories for dynamic navigation
const categories = [...new Set(allContent.map(c => c.webCategory).filter(Boolean))].sort();
---

<Layout 
  title="Sabrina's Pause" 
  description="Moments Between ‚Äî A Digital Archive"
  experienceCount={allContent.length}
  preloadImage={allContent[0]?.heroImage}
>
  <div class="min-h-screen bg-white">
    
    <!-- Header - Responsive -->
    <header class="border-b border-neutral-200">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 py-10 sm:py-16">
        <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-neutral-900 mb-3 sm:mb-4 tracking-tight">
          Sabrina's Pause
        </h1>
        <p class="text-lg sm:text-2xl text-neutral-600">
          Moments Between
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 py-10 sm:py-16">
      
      <!-- Filter Navigation - Dynamic from Category tags (M2 Requirement) -->
      {allContent.length > 0 && (
        <div class="flex flex-wrap gap-2 sm:gap-3 mb-8 sm:mb-12 pb-4 sm:pb-6 border-b border-neutral-200">
          <button class="filter-btn active min-h-[44px] px-4 py-2 rounded-full bg-neutral-900 text-white text-sm font-medium transition-colors touch-manipulation" data-filter="all">
            All ({allContent.length})
          </button>
          {categories.map(category => (
            <button class="filter-btn min-h-[44px] px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 hover:bg-neutral-200 text-sm font-medium transition-colors touch-manipulation" data-filter={category.toLowerCase()}>
              {category} ({allContent.filter(c => c.webCategory === category).length})
            </button>
          ))}
        </div>
      )}
      
      {allContent.length === 0 ? (
        <div class="text-center py-20">
          <p class="text-neutral-400 text-lg">No content published yet</p>
        </div>
      ) : (
        <>
          <!-- Content Grid -->
          <div class="grid gap-8 sm:gap-12 mb-12 sm:mb-20">
            {allContent.map((content, idx) => {
              // Route to content-type specific pages
              const contentUrl = `/${content.contentType}/${content.slug}`;
              const isFirstLcp = idx === 0; // First image = LCP candidate
              return (
              <article class="group content-item" data-category={content.webCategory.toLowerCase()}>
                <a href={contentUrl} class="block">
                  <div class="flex flex-col md:flex-row gap-8">
                    
                    <!-- Image/Icon Area -->
                    <div class="md:w-1/3 flex-shrink-0">
                      <div class="aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden group-hover:opacity-90 transition-opacity">
                        {content.heroImage ? (
                          <Image 
                            src={content.heroImage} 
                            alt={content.title}
                            width={content.heroImageWidth ?? 800}
                            height={content.heroImageHeight ?? 600}
                            class="w-full h-full object-cover"
                            loading={isFirstLcp ? "eager" : "lazy"}
                            fetchpriority={isFirstLcp ? "high" : undefined}
                          />
                        ) : (
                          <div class="w-full h-full flex items-center justify-center bg-neutral-100">
                            <span class="text-7xl opacity-40">
                              {content.contentType === 'article' ? 'üìÑ' : content.contentType === 'comic' ? 'üé®' : 'üéôÔ∏è'}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <!-- Content Info -->
                    <div class="md:w-2/3">
                      <div class="flex items-center gap-3 mb-3">
                        <span class="text-sm text-neutral-500 font-medium">
                          {content.webCategory}
                        </span>
                        <span class="text-neutral-300">¬∑</span>
                        <span class="text-sm text-neutral-400">{content.date}</span>
                      </div>
                      
                      <h2 class="text-3xl font-bold text-neutral-900 mb-3 group-hover:text-neutral-600 transition-colors">
                        {content.title}
                      </h2>
                      
                      <p class="text-lg text-neutral-600 mb-4 leading-relaxed">
                        {content.intentVector}
                      </p>
                      
                      <div class="flex flex-wrap gap-4 text-sm text-neutral-500 mb-4">
                        <div class="flex items-center gap-2">
                          <span class="font-medium">Location:</span>
                          <span>{content.location.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="font-medium">SD-Index:</span>
                          <span>{content.sdIndex}/10</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="font-medium">Type:</span>
                          <span class="uppercase text-xs">{content.contentType}</span>
                        </div>
                      </div>
                      
                      {content.project.length > 0 && (
                        <div class="flex gap-2 flex-wrap">
                          {content.project.map((p) => (
                            <span class="text-xs px-3 py-1 bg-neutral-100 text-neutral-700 rounded-full">
                              {p}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </a>
              </article>
            )})}
          </div>
          
          <!-- Empty State -->
          <div id="empty-state" class="hidden py-32 text-center">
            <div class="text-4xl mb-4">üå™Ô∏è</div>
            <h3 class="text-xl font-bold text-neutral-900 mb-2">Stillness Found</h3>
            <p class="text-neutral-500">No moments match this specific category yet.</p>
            <button onclick="document.querySelector('[data-filter=\'all\']').click()" class="mt-6 text-sm font-bold border-b-2 border-neutral-900 pb-1">Reset Filters</button>
          </div>

          <!-- Pagination Placeholder -->
          <div class="flex justify-center gap-4 py-8 border-t border-neutral-200">
            <span class="px-4 py-2 bg-neutral-900 text-white rounded">1</span>
            <span class="px-4 py-2 text-neutral-400">of 1</span>
          </div>
        </>
      )}

    </main>
  </div>
</Layout>

<script>
  function filterContent() {
    const buttons = document.querySelectorAll('.filter-btn');
    const items = document.querySelectorAll('.content-item');
    const emptyState = document.getElementById('empty-state');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter') || 'all';
        let visibleCount = 0;

        // Update UI
        buttons.forEach(b => {
          b.classList.remove('active', 'bg-neutral-900', 'text-white');
          b.classList.add('bg-neutral-100', 'text-neutral-700');
        });
        btn.classList.add('active', 'bg-neutral-900', 'text-white');
        btn.classList.remove('bg-neutral-100', 'text-neutral-700');

        // Filter items with fade
        items.forEach(item => {
          const el = item as HTMLElement;
          const category = el.getAttribute('data-category');
          
          el.style.opacity = '0';
          
          setTimeout(() => {
            if (filter === 'all' || category === filter) {
              el.style.display = 'block';
              visibleCount++;
              setTimeout(() => { el.style.opacity = '1'; }, 20);
            } else {
              el.style.display = 'none';
            }
            
            // Toggle empty state
            if (emptyState) {
              emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
            }
          }, 150);
        });
      });
    });
  };

  // Run on initial load (MPA: DOMContentLoaded)
  document.addEventListener('DOMContentLoaded', filterContent);
</script>

<style>
  .content-item {
    transition: opacity 0.3s ease-in-out;
  }
</style>
