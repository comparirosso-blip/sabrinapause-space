---
/**
 * Podcast Template
 * Native HTML5 audio player with transcript
 * Optimized for audio content consumption
 */

import Layout from '../../layouts/Layout.astro';
import { NotionLoader } from '../../lib/notion-loader';
import { renderBlocks } from '../../lib/block-renderer';

const { slug } = Astro.params;

const loader = new NotionLoader(
  import.meta.env.NOTION_API_KEY,
  import.meta.env.NOTION_DATABASE_ID,
  { cacheImages: false }
);

const content = await loader.getBySlug(slug as string);

if (!content || content.contentType !== 'podcast') {
  return Astro.redirect('/404');
}

const renderedContent = renderBlocks(content.blocks);

// Extract audio file if exists (from Notion file blocks)
// For now, we'll use a placeholder. In production, you'd extract from Notion blocks
const audioUrl = content.blocks.find(b => b.type === 'file')?.file?.url || '';

// Estimate duration (placeholder - would come from audio metadata)
const duration = '30:00'; 

// Generate JSON-LD for PodcastEpisode
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'PodcastEpisode',
  name: content.title,
  description: content.intentVector.join(', '),
  image: content.heroImage || '',
  datePublished: content.date,
  creator: {
    '@type': 'Person',
    name: 'Sabrina Lin',
    url: 'https://sabrinapause.space'
  },
  publisher: {
    '@type': 'Organization',
    name: 'Sabrina Pause',
    logo: {
      '@type': 'ImageObject',
      url: 'https://sabrinapause.space/logo.png'
    }
  },
  audio: audioUrl ? {
    '@type': 'AudioObject',
    contentUrl: audioUrl,
    duration: duration,
    encodingFormat: 'audio/mpeg'
  } : undefined,
  partOfSeries: {
    '@type': 'PodcastSeries',
    name: 'Sabrina Pause Podcast',
    url: 'https://sabrinapause.space'
  },
  inLanguage: content.language,
  keywords: [...content.concepts, ...content.intentVector]
};

export async function getStaticPaths() {
  const loader = new NotionLoader(
    import.meta.env.NOTION_API_KEY,
    import.meta.env.NOTION_DATABASE_ID
  );
  
  const podcasts = await loader.getAll('podcast');
  
  return podcasts.map((podcast) => ({
    params: { slug: podcast.slug },
  }));
}
---

<Layout title={content.title} description={content.intentVector.join(' ¬∑ ')}>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <article class="min-h-screen bg-gradient-to-b from-neutral-50 to-white">
    
    <!-- Podcast Header -->
    <header class="max-w-4xl mx-auto px-6 pt-12 pb-8">
      
      <!-- Breadcrumb -->
      <nav class="text-sm text-neutral-500 hover:text-neutral-900 mb-8">
        <a href="/" class="inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Back to all experiences
        </a>
      </nav>
      
      <!-- Metadata Badge -->
      <div class="flex items-center gap-3 mb-6 text-sm">
        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full font-medium uppercase tracking-wide text-xs">
          üéôÔ∏è {content.webCategory}
        </span>
        <span class="text-neutral-500">¬∑</span>
        <time datetime={content.date} class="text-neutral-600">{content.date}</time>
      </div>
      
      <!-- Title -->
      <h1 class="text-5xl md:text-6xl font-bold text-neutral-900 mb-4 leading-tight tracking-tight">
        {content.title}
      </h1>
      
      <!-- Intent Vector -->
      {content.intentVector.length > 0 && (
        <p class="text-xl text-neutral-600 mb-8 leading-relaxed font-light">
          {content.intentVector.join(' ¬∑ ')}
        </p>
      )}
      
    </header>
    
    <!-- Audio Player Card -->
    <div class="max-w-4xl mx-auto px-6 mb-12">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-neutral-200">
        
        <!-- Cover Art + Meta -->
        <div class="flex flex-col md:flex-row gap-6 p-6 md:p-8">
          
          <!-- Cover Image -->
          {content.heroImage && (
            <div class="flex-shrink-0">
              <img 
                src={content.heroImage} 
                alt={content.title}
                class="w-full md:w-48 md:h-48 rounded-lg shadow-lg object-cover"
                loading="eager"
              />
            </div>
          )}
          
          <!-- Player Info -->
          <div class="flex-1 flex flex-col justify-between">
            <div>
              <div class="text-sm text-neutral-500 uppercase tracking-wide mb-2">Episode</div>
              <h2 class="text-2xl font-bold text-neutral-900 mb-3">{content.title}</h2>
              <div class="flex items-center gap-4 text-sm text-neutral-600 mb-4">
                <span>‚è±Ô∏è {duration}</span>
                <span>¬∑</span>
                <span>üìç {content.location.name}</span>
              </div>
            </div>
            
            <!-- Audio Player -->
            {audioUrl ? (
              <div class="space-y-3">
                <audio 
                  id="podcast-player"
                  controls 
                  preload="metadata"
                  class="w-full"
                  style="height: 48px;"
                >
                  <source src={audioUrl} type="audio/mpeg" />
                  Your browser does not support the audio element.
                </audio>
                
                <!-- Playback Speed -->
                <div class="flex items-center gap-2 text-sm">
                  <span class="text-neutral-500">Speed:</span>
                  <button class="speed-btn px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200 transition-colors" data-speed="0.75">0.75√ó</button>
                  <button class="speed-btn px-2 py-1 rounded bg-neutral-900 text-white" data-speed="1">1√ó</button>
                  <button class="speed-btn px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200 transition-colors" data-speed="1.25">1.25√ó</button>
                  <button class="speed-btn px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200 transition-colors" data-speed="1.5">1.5√ó</button>
                  <button class="speed-btn px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200 transition-colors" data-speed="2">2√ó</button>
                </div>
              </div>
            ) : (
              <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                ‚ö†Ô∏è Audio file not yet uploaded to Notion
              </div>
            )}
          </div>
          
        </div>
        
      </div>
    </div>
    
    <!-- Content Tabs -->
    <div class="max-w-4xl mx-auto px-6 pb-16">
      
      <!-- Tab Navigation -->
      <div class="flex gap-4 border-b border-neutral-200 mb-8">
        <button class="tab-btn active px-4 py-3 font-medium border-b-2 border-neutral-900 text-neutral-900 transition-colors" data-tab="transcript">
          Transcript
        </button>
        <button class="tab-btn px-4 py-3 font-medium border-b-2 border-transparent text-neutral-500 hover:text-neutral-900 transition-colors" data-tab="metadata">
          Metadata
        </button>
      </div>
      
      <!-- Tab Content -->
      <div id="tab-content">
        
        <!-- Transcript Tab -->
        <div class="tab-panel active" data-panel="transcript">
          <div class="prose prose-lg prose-neutral max-w-none bg-white rounded-lg p-8 shadow-sm border border-neutral-100">
            <Fragment set:html={renderedContent} />
          </div>
        </div>
        
        <!-- Metadata Tab -->
        <div class="tab-panel hidden" data-panel="metadata">
          <div class="bg-white rounded-lg p-8 shadow-sm border border-neutral-100 space-y-6">
            
            <div class="grid grid-cols-2 gap-6">
              <div>
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">Location</div>
                <div class="text-neutral-900 font-medium">{content.location.name}</div>
              </div>
              <div>
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">SD-Index‚Ñ¢</div>
                <div class="text-neutral-900 font-medium">{content.sdIndex}/10</div>
              </div>
              {content.lux !== null && (
                <div>
                  <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">Lux</div>
                  <div class="text-neutral-900 font-medium">{content.lux}</div>
                </div>
              )}
              {content.texture && (
                <div>
                  <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">Texture</div>
                  <div class="text-neutral-900 font-medium capitalize">{content.texture}</div>
                </div>
              )}
            </div>
            
            {content.concepts.length > 0 && (
              <div>
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-3">Topics</div>
                <div class="flex gap-2 flex-wrap">
                  {content.concepts.map((concept) => (
                    <span class="text-sm px-3 py-1.5 bg-neutral-50 text-neutral-700 rounded-full border border-neutral-200">
                      {concept}
                    </span>
                  ))}
                </div>
              </div>
            )}
            
            <div class="pt-6 border-t border-neutral-200">
              <div class="text-xs text-neutral-500 mb-2">Last updated</div>
              <time datetime={content.last_updated} class="text-neutral-700">
                {new Date(content.last_updated).toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                })}
              </time>
            </div>
            
          </div>
        </div>
        
      </div>
      
    </div>
    
  </article>
</Layout>

<style>
  /* Podcast Typography */
  .prose {
    color: #404040;
    line-height: 1.8;
  }
  
  .prose :global(p) {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }
  
  .prose :global(strong) {
    color: #171717;
    font-weight: 600;
  }
  
  /* Audio Player Styling */
  audio {
    border-radius: 8px;
    background: #f5f5f5;
  }
  
  audio::-webkit-media-controls-panel {
    background: #fafafa;
  }
  
  /* Tab Styling */
  .tab-panel.hidden {
    display: none;
  }
  
  .tab-panel.active {
    display: block;
  }
</style>

<script>
  // Playback speed controls
  document.querySelectorAll('.speed-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const speed = parseFloat(btn.getAttribute('data-speed') || '1');
      const player = document.getElementById('podcast-player') as HTMLAudioElement;
      
      if (player) {
        player.playbackRate = speed;
        
        // Update active state
        document.querySelectorAll('.speed-btn').forEach(b => {
          b.classList.remove('bg-neutral-900', 'text-white');
          b.classList.add('bg-neutral-100');
        });
        btn.classList.remove('bg-neutral-100');
        btn.classList.add('bg-neutral-900', 'text-white');
      }
    });
  });
  
  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.getAttribute('data-tab');
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active', 'border-neutral-900', 'text-neutral-900');
        b.classList.add('border-transparent', 'text-neutral-500');
      });
      btn.classList.add('active', 'border-neutral-900', 'text-neutral-900');
      btn.classList.remove('border-transparent', 'text-neutral-500');
      
      // Update panels
      document.querySelectorAll('.tab-panel').forEach(panel => {
        if (panel.getAttribute('data-panel') === tabName) {
          panel.classList.remove('hidden');
          panel.classList.add('active');
        } else {
          panel.classList.add('hidden');
          panel.classList.remove('active');
        }
      });
    });
  });
</script>
